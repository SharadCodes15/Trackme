{% extends "layout.html" %}

{% block content %}
<div class="space-y-8">
    <!-- Header -->
    <header class="glass-panel p-6 rounded-2xl">
        <div class="flex items-center gap-3">
            <svg class="w-8 h-8 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <div>
                <h1 class="text-3xl font-bold text-white tracking-tight">Attendance Tracker</h1>
                <p class="text-slate-400 mt-1">Select a subject to mark attendance</p>
            </div>
        </div>
    </header>

    {% if subjects|length == 0 %}
    <!-- No Subjects -->
    <div class="glass-panel p-10 rounded-2xl text-center border-dashed border-2 border-slate-700">
        <svg class="w-16 h-16 mx-auto mb-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
        </svg>
        <p class="text-slate-400 text-lg mb-4">No subjects found. Please run the seed script to add subjects.</p>
        <code class="bg-slate-800 px-4 py-2 rounded text-emerald-400">python seed_subjects.py</code>
    </div>
    {% else %}

    <!-- Subject Tile Grid -->
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        {% for subject in subjects %}
        <div onclick="openModal('{{ subject.id }}', '{{ subject.name }}')"
            class="group relative aspect-square glass-card rounded-2xl flex flex-col items-center justify-center p-6 cursor-pointer hover:-translate-y-2 hover:shadow-emerald-500/10 transition-all duration-300">

            <!-- Icon/Visual -->
            <div
                class="w-16 h-16 rounded-full bg-slate-800/50 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform duration-300 border border-slate-700/50 group-hover:border-emerald-500/30">
                <span class="text-2xl font-bold text-slate-400 group-hover:text-emerald-400 transition-colors">
                    {{ subject.name[:2] }}
                </span>
            </div>

            <!-- Name -->
            <h3 class="text-xl font-bold text-center text-white group-hover:text-emerald-300 transition-colors">{{
                subject.name }}</h3>

            <!-- Status Indicator (Small dot) -->
            <div id="tile-status-{{ subject.id }}" class="absolute top-4 right-4">
                {% if subject.today_status == 'Present' %}
                <div class="w-3 h-3 rounded-full bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]"></div>
                {% elif subject.today_status == 'Absent' %}
                <div class="w-3 h-3 rounded-full bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.5)]"></div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Attendance Modal (Hidden) -->
    <div id="attendance-modal"
        class="fixed inset-0 z-[110] flex items-center justify-center opacity-0 pointer-events-none transition-all duration-300 backdrop-blur-sm bg-slate-950/60">

        <!-- Modal Content -->
        <div id="modal-content"
            class="glass-panel w-full max-w-5xl mx-4 rounded-3xl overflow-hidden transform scale-95 transition-all duration-300 shadow-2xl ring-1 ring-white/10">

            <!-- Modal Header -->
            <div class="px-8 py-6 border-b border-white/5 flex items-center justify-between bg-slate-900/40">
                <div>
                    <h2 class="text-3xl font-bold text-white" id="modal-subject-name">Subject Name</h2>
                    <p class="text-slate-400 mt-1" id="modal-date">{{ today.strftime('%a, %d %b %Y') }}</p>
                </div>
                <button onclick="closeModal()"
                    class="p-2 rounded-full hover:bg-slate-800/50 text-slate-400 hover:text-white transition-colors">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                        </path>
                    </svg>
                </button>
            </div>

            <!-- Modal Body -->
            <div class="p-8 grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12">
                <!-- Left Column: Controls -->
                <div class="space-y-8 flex flex-col justify-center">
                    <div class="text-center space-y-2 mb-4">
                        <span class="text-slate-400 text-sm uppercase tracking-wider font-medium">Mark Attendance</span>
                    </div>

                    <div class="grid grid-cols-1 gap-4">
                        <button onclick="markCurrent('Present')"
                            class="group relative overflow-hidden bg-gradient-to-r from-emerald-600 to-emerald-500 hover:from-emerald-500 hover:to-emerald-400 text-white p-6 rounded-2xl transition-all shadow-lg shadow-emerald-500/20 hover:shadow-emerald-500/40 active:scale-98 flex items-center justify-between">
                            <span class="text-2xl font-bold">Present</span>
                            <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                        d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                        </button>

                        <button onclick="markCurrent('Absent')"
                            class="group relative overflow-hidden bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 text-white p-6 rounded-2xl transition-all shadow-lg shadow-red-500/20 hover:shadow-red-500/40 active:scale-98 flex items-center justify-between">
                            <span class="text-2xl font-bold">Absent</span>
                            <div class="w-12 h-12 rounded-full bg-white/20 flex items-center justify-center">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3"
                                        d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </div>
                        </button>
                    </div>

                    <div id="current-status-display" class="text-center min-h-[40px]">
                        <!-- Dynamic Status Text -->
                    </div>
                </div>

                <!-- Right Column: Charts -->
                <div class="space-y-6">
                    <!-- Overall Stats -->
                    <div class="glass-card p-5 rounded-2xl bg-slate-900/30">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-semibold text-slate-300">Overall Attendance</h3>
                            <span class="text-2xl font-bold text-emerald-400" id="overall-percentage">0%</span>
                        </div>
                        <div class="h-32 relative">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>

                    <!-- Subject Breakdown -->
                    <div class="glass-card p-5 rounded-2xl bg-slate-900/30">
                        <h3 class="text-sm font-semibold text-slate-300 mb-3">Subject Breakdown</h3>
                        <div class="h-40 relative">
                            <canvas id="barChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
    <!-- Toast Notification -->
    <div id="toast"
        class="fixed bottom-6 right-6 z-[120] transform translate-y-24 opacity-0 transition-all duration-300">
        <div class="glass-panel px-6 py-4 rounded-xl flex items-center gap-3 border-l-4 border-emerald-500 shadow-2xl">
            <div class="w-8 h-8 rounded-full bg-emerald-500/20 flex items-center justify-center text-emerald-400">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <div>
                <h4 class="font-bold text-white">Success</h4>
                <p class="text-sm text-slate-300" id="toast-message">Attendance marked!</p>
            </div>
        </div>
    </div>
</div>

<script>
    let pieChart = null;
    let barChart = null;
    let currentSubjectId = null;

    // Modal Functions
    function openModal(id, name) {
        currentSubjectId = id;
        document.getElementById('modal-subject-name').textContent = name;

        // Reset status display
        const statusEl = document.getElementById(`tile-status-${id}`);
        const displayEl = document.getElementById('current-status-display');

        // Copy current status to modal display
        if (statusEl.querySelector('.bg-emerald-500')) {
            updateModalStatusDisplay('Present');
        } else if (statusEl.querySelector('.bg-red-500')) {
            updateModalStatusDisplay('Absent');
        } else {
            displayEl.innerHTML = '<span class="text-slate-500">Not marked yet</span>';
        }

        // Show Modal with Animation
        const modal = document.getElementById('attendance-modal');
        const content = document.getElementById('modal-content');

        modal.classList.remove('opacity-0', 'pointer-events-none');
        content.classList.remove('scale-95');
        content.classList.add('scale-100');

        // Load charts for this subject
        loadSubjectAnalytics(id);
    }

    function closeModal() {
        const modal = document.getElementById('attendance-modal');
        const content = document.getElementById('modal-content');

        modal.classList.add('opacity-0', 'pointer-events-none');
        content.classList.remove('scale-100');
        content.classList.add('scale-95');

        currentSubjectId = null;
    }

    // Close on background click
    document.getElementById('attendance-modal').addEventListener('click', (e) => {
        if (e.target === document.getElementById('attendance-modal')) {
            closeModal();
        }
    });

    // Wrapper for Mark Attendance
    function markCurrent(status) {
        if (currentSubjectId) {
            markAttendance(currentSubjectId, status);
        }
    }

    // Mark Attendance API Call
    async function markAttendance(subjectId, status) {
        try {
            const response = await fetch('/mark-attendance', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    subject_id: subjectId,
                    status: status,
                    date: '{{ today.isoformat() }}'
                })
            });

            if (!response.ok) throw new Error('Failed to mark attendance');

            // Update UI
            updateTileStatus(subjectId, status);
            updateModalStatusDisplay(status);
            showToast(`Marked as ${status}`);

            // Refresh analytics for this subject
            await loadSubjectAnalytics(subjectId);

        } catch (error) {
            console.error('Error marking attendance:', error);
            showToast('Error marking attendance', true);
        }
    }

    function updateTileStatus(id, status) {
        const el = document.getElementById(`tile-status-${id}`);
        if (status === 'Present') {
            el.innerHTML = '<div class="w-3 h-3 rounded-full bg-emerald-500 shadow-[0_0_10px_rgba(16,185,129,0.5)]"></div>';
        } else {
            el.innerHTML = '<div class="w-3 h-3 rounded-full bg-red-500 shadow-[0_0_10px_rgba(239,68,68,0.5)]"></div>';
        }
    }

    function updateModalStatusDisplay(status) {
        const displayEl = document.getElementById('current-status-display');
        if (status === 'Present') {
            displayEl.innerHTML = '<span class="text-emerald-400 font-medium flex items-center justify-center gap-2"><div class="w-2 h-2 rounded-full bg-emerald-500"></div> Marked Present</span>';
        } else {
            displayEl.innerHTML = '<span class="text-red-400 font-medium flex items-center justify-center gap-2"><div class="w-2 h-2 rounded-full bg-red-500"></div> Marked Absent</span>';
        }
    }

    function showToast(message, isError = false) {
        const toast = document.getElementById('toast');
        const msgEl = document.getElementById('toast-message');
        const borderEl = toast.firstElementChild;
        const iconEl = borderEl.firstElementChild;

        msgEl.textContent = message;

        if (isError) {
            borderEl.classList.replace('border-emerald-500', 'border-red-500');
            iconEl.classList.replace('bg-emerald-500/20', 'bg-red-500/20');
            iconEl.classList.replace('text-emerald-400', 'text-red-400');
        } else {
            borderEl.classList.replace('border-red-500', 'border-emerald-500');
            iconEl.classList.replace('bg-red-500/20', 'bg-emerald-500/20');
            iconEl.classList.replace('text-red-400', 'text-emerald-400');
        }

        toast.classList.remove('translate-y-24', 'opacity-0');

        setTimeout(() => {
            toast.classList.add('translate-y-24', 'opacity-0');
        }, 3000);
    }

    // Analytics Logic
    async function loadSubjectAnalytics(subjectId) {
        try {
            const response = await fetch(`/api/subject_stats/${subjectId}`);
            if (!response.ok) throw new Error('Failed to load stats');
            const stats = await response.json();

            document.getElementById('overall-percentage').textContent = `${stats.percentage}%`;

            updatePieChart(stats);
            updateBarChart(stats);
        } catch (error) {
            console.error('Error loading analytics:', error);
        }
    }

    function updatePieChart(stats) {
        const ctx = document.getElementById('pieChart').getContext('2d');
        if (pieChart) pieChart.destroy();

        pieChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Present', 'Absent'],
                datasets: [{
                    data: [stats.present, stats.absent],
                    backgroundColor: ['#10b981', '#ef4444'],
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '70%',
                plugins: {
                    legend: { position: 'right', labels: { color: '#94a3b8', font: { size: 12 } } },
                    title: { display: false }
                }
            }
        });
    }

    function updateBarChart(stats) {
        const ctx = document.getElementById('barChart').getContext('2d');
        if (barChart) barChart.destroy();

        barChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Present', 'Absent'],
                datasets: [{
                    label: 'Days',
                    data: [stats.present, stats.absent],
                    backgroundColor: ['#10b981', '#ef4444'],
                    barThickness: 24,
                    borderRadius: 4
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        ticks: { color: '#64748b', stepSize: 1 }
                    },
                    y: {
                        grid: { display: false },
                        ticks: { color: '#94a3b8', font: { weight: 'bold' } }
                    }
                }
            }
        });
    }
</script>
{% endblock %}